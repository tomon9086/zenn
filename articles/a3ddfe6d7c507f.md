---
title: "Next.jsï¼ˆVercelï¼‰ã§Hydration failedã‚’äºˆé˜²ã—ãŸã„ï¼Ÿ"
emoji: "ðŸ’§"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [nextjs, react]
published: true
---

# TL; DR

Next.jsã®Devã‚µãƒ¼ãƒã®ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã‚’UTCã«ã—ã¡ã‚ƒãŠã†ï¼

```json:package.json
{
  "scripts": {
    "dev": "TZ='Etc/UTC' next dev"
  }
}
```

# ç—‡çŠ¶
Next.jsã§ã¯ã€React 18ã® [Hydrationã¨ã„ã†æ©Ÿèƒ½](https://nextjs.org/docs/messages/react-hydration-error) ã«ã‚ˆã£ã¦ã€ã‚µãƒ¼ãƒã‚µã‚¤ãƒ‰ã§ç”Ÿæˆã•ã‚ŒãŸHTMLæ§‹é€ ã¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚ŒãŸHTMLã®æ§‹é€ ãŒç•°ãªã‚‹å ´åˆã«

```plain:Minified React Error #418
Hydration failed because the initial UI does not match what was rendered on the server.
```

```plain:Minified React Error #423
There was an error while hydrating. Because the error happened outside of a Suspense boundary, the entire root will switch to client rendering.
```

```plain:Minified React Error #425
Text content does not match server-rendered HTML.
```

ã®ã‚ˆã†ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã™ã€‚

ç§ã®å ´åˆã¯ã€ã“ã‚ŒãŒãƒ­ãƒ¼ã‚«ãƒ«ã®Devã‚µãƒ¼ãƒã§ã¯ç™ºç”Ÿã—ãªã„ã®ã«æœ¬ç•ªã§ã“ã®ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¦å›°ã£ã¦ã„ã¾ã—ãŸã€‚

## Hydrationã«ã¤ã„ã¦
Next.jsã§ã¯ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰ã‚’é«˜é€ŸåŒ–ã™ã‚‹ãŸã‚ã«ã‚µãƒ¼ãƒã‚µã‚¤ãƒ‰ã§äºˆã‚HTMLã®å¤§æž ã‚’ç”Ÿæˆã—ã¦ãŠãã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒãƒšãƒ¼ã‚¸ï¼ˆHTMLï¼‰ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸç›´å¾Œã¯ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãªè¦ç´ ãŒã¾ã å‹•ã‹ãªã„çŠ¶æ…‹ã«ãªã£ã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚
JSã‚’èª­ã¿è¾¼ã¿çµ‚ã‚ã£ã¦å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«ãªã£ãŸã‚‰ã€ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãªè¦ç´ ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã§ãƒšãƒ¼ã‚¸ã®æº–å‚™ãŒæ•´ã„ã¾ã™ã€‚
ã“ã®ã€äº‹å‰ã«èª­ã¿è¾¼ã‚“ã HTMLã«JSã§ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãªã©ã‚’ä»˜ä¸Žã—ã¦ã„ãã¯ãŸã‚‰ãã®ã“ã¨ã‚’ **Hydration** ã¨å‘¼ã³ã¾ã™ã€‚

_å‚è€ƒ: [Pre-rendering and Data Fetching](https://nextjs.org/learn/basics/data-fetching/pre-rendering)_

ã“ã‚Œã¯è¦ªåˆ‡ã«ã‚‚ã€ç‰¹ã«è¨­å®šã™ã‚‹ã“ã¨ãªãåˆ©ç”¨ã§ãã‚‹æ©Ÿèƒ½ã§ã™ã€‚
æ„è­˜ã™ã‚‹ã“ã¨ãªãä½¿ãˆã¦ã—ã¾ã£ã¦ã„ã‚‹ãŸã‚ã«ã€çŸ¥ã‚‰ãªã„ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¦æˆ¸æƒ‘ã†äººã‚‚å¤§å‹¢ã„ãã†ã§ã¯ã‚ã‚Šã¾ã™â€¦ã€‚

# åŽŸå› 
ç¾åœ¨æ™‚åˆ»ã‚’ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼ˆrenderé–¢æ•°ï¼‰å†…ã«ç›´æŽ¥è¨˜è¿°ã™ã‚‹ãªã©ã€ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ä¾å­˜ã§è¡¨ç¤ºãŒå¤‰ã‚ã‚‹ã‚ˆã†ãªå®Ÿè£…ã‚’ã—ã¦ã„ã¾ã—ãŸã€‚

```tsx:ã‚¤ãƒ¡ãƒ¼ã‚¸
const component = () => {
  return (
    <div>
      {DateTime.fromJSDate(new Date()).toFormat(
        'yyyy-MM-dd HH:mm:ss'
      )}
    </div>
  )
}
```

Vercelã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹å ´åˆã€ã‚µãƒ¼ãƒã‚µã‚¤ãƒ‰ã®æ©Ÿèƒ½ã¯Serverless Functionsã§å®Ÿè¡Œã•ã‚Œã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚ãã—ã¦Hydrationã®ãŸã‚ã«äº‹å‰ã«HTMLã‚’ç”Ÿæˆã™ã‚‹å‡¦ç†ã‚‚ä¾‹å¤–ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
Serverless Functionsä¸Šã§ã¯ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ãŒUTCã«è¨­å®šã•ã‚Œã¦ãŠã‚Šã€UTCä»¥å¤–ã®ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³è¨­å®šã®ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ã‹ã‚‰ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸå ´åˆã¯ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ä¾å­˜ã®è¡¨ç¤ºã«å·®ãŒç”Ÿã˜ã€Hydration failedã®ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã™ã€‚

ã—ã‹ã—ã€Devã‚µãƒ¼ãƒã§ã¯å½“ç„¶ã‚µãƒ¼ãƒã‚µã‚¤ãƒ‰ã‚‚ãƒ­ãƒ¼ã‚«ãƒ«ã®ãƒžã‚·ãƒ³ã§å‹•ã„ã¦ã„ã‚‹ã®ã§ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¨ã‚µãƒ¼ãƒãŒåŒã˜ã‚·ã‚¹ãƒ†ãƒ ã®ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã‚’ä½¿ã†ã“ã¨ã¨ãªã‚Šã€é–‹ç™ºç’°å¢ƒã§ã¯äº‹å‰ã«ã‚µãƒ¼ãƒã‚µã‚¤ãƒ‰ã§ç”Ÿæˆã•ã‚ŒãŸHTMLã¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§å®Ÿéš›ã«ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚ŒãŸHTMLã«å·®ãŒç”Ÿã˜ãªã„ãŸã‚ã€Hydration failedã®ã‚¨ãƒ©ãƒ¼ã¯æœ¬ç•ªç’°å¢ƒã§ã®ã¿ç™ºç”Ÿã™ã‚‹ã“ã¨ã¨ãªã‚Šã¾ã™ã€‚

:::message
- `a` ã‚¿ã‚°ã®ä¸­ã§ `a` ã‚¿ã‚°ã‚’ä½¿ã†
- `p` ã‚¿ã‚°ã®ä¸­ã§ `p` ã‚¿ã‚°ã‚’ä½¿ã†
- `p` ã‚¿ã‚°ã®ä¸­ã§ `div` ã‚¿ã‚°ã‚’ä½¿ã†

ãªã©ã€HTMLã®ãƒ«ãƒ¼ãƒ«ã‚’çŠ¯ã—ã¦ã„ã¦ã“ã®ã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹ã“ã¨ã‚‚ã‚ã‚‹ã®ã§ã™ãŒã€ãã†ã„ã†å ´åˆã¯ãƒ­ãƒ¼ã‚«ãƒ«ã§ã‚‚åŒã˜ã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹ã®ã§æ¯”è¼ƒçš„ç°¡å˜ã«åŽŸå› ãŒç‰¹å®šã§ãã‚‹ã¯ãšã§ã™ã€‚
:::

# å¯¾ç­–

Next.jsã®Devã‚µãƒ¼ãƒã®ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã‚’UTCã«è¨­å®šã™ã‚Œã°ã€é–‹ç™ºç’°å¢ƒã¨æœ¬ç•ªç’°å¢ƒï¼ˆVercelï¼‰ã¨ã®å·®ç•°ãŒå°ã•ããªã‚‹ã®ã§ã¯ï¼Ÿã¨æ€ã£ãŸã‚ã‘ã§ã‚ã‚Šã¾ã™ã€‚

Devã‚µãƒ¼ãƒã®ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã¯ `TZ` ç’°å¢ƒå¤‰æ•°ã§ç°¡å˜ã«è¨­å®šã§ãã¾ã™ã€‚

```json:package.json
{
  "scripts": {
    "dev": "TZ='Etc/UTC' next dev"
  }
}
```

ã‹ãªã‚Šé™å®šçš„ãªã‚¨ãƒ©ãƒ¼ã¨å¯¾å¿œã§ã¯ã‚ã‚Šã¾ã™ãŒã€æœ¬ç•ªç’°å¢ƒã§minifyã•ã‚ŒãŸReactãŒåãã‚¨ãƒ©ãƒ¼ã‚ˆã‚Šã‚‚é–‹ç™ºç’°å¢ƒã®åãã‚¨ãƒ©ãƒ¼ã®æ–¹ãŒã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹ãªã©å……å®Ÿã—ã¦ã„ã¦è§£æ±ºãŒæ¥½ãªã®ã§ã€åŒã˜ã‚¨ãƒ©ãƒ¼ã«æ‚©ã‚€æ–¹ã®ä¸€åŠ©ã«ãªã‚Œã°ã¨æ€ã„å…±æœ‰ã—ã¾ã™ã€‚

# ã¡ãªã¿ã«â€¦
ä¸Šã«ç¤ºã—ãŸã‚¤ãƒ¡ãƒ¼ã‚¸ã®ã‚³ãƒ¼ãƒ‰ã¯ä¸‹ã®ã‚ˆã†ã«ä¿®æ­£ã™ã‚‹ã“ã¨ã§ã‚¨ãƒ©ãƒ¼ã‚’è§£æ¶ˆã§ãã¾ã™ï¼ˆ`useEffect` ã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã§ã®ã¿å®Ÿè¡Œã•ã‚Œã‚‹ãŸã‚ï¼‰ã€‚

```tsx:ã‚¤ãƒ¡ãƒ¼ã‚¸ï¼ˆä¿®æ­£å‰ï¼‰
const component = () => {
  return (
    <div>
      {DateTime.fromJSDate(new Date()).toFormat(
        'yyyy-MM-dd HH:mm:ss'
      )}
    </div>
  )
}
```

```tsx:ã‚¤ãƒ¡ãƒ¼ã‚¸ï¼ˆä¿®æ­£å¾Œï¼‰
const component = () => {
    const [formattedDate, setFormattedDate] = useState<string>()
    
    useEffect(() => {
      setFormattedDate(
        DateTime.fromJSDate(new Date()).toFormat('yyyy-MM-dd HH:mm:ss')
      )
    }, [])

  return (
    <div>{formattedDate}</div>
  )
}
```